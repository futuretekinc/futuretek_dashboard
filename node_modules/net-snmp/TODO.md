
# TODO

 * Use a single socket per session
 * Create toBuffer() and fromBuffer() functions for each PDU type
 * Create a PduParser.parse() class and function
 * Create a Transport.listen() class and function for UDP and IPv4, and UDP
   and IPv6, pass in callback for Transport.on("message", function(buffer)...)
 * Create a Dispatcher.dispatch() class and function to:
    * Take Buffer objects from a Transport classes message event
    * Read the version of the message
    * Pass to the appropriate MessageProcessor.process() function and give a
      callback which will be called with a PDU, i.e.:
       MessageProcesser.process(message, function(error, pdu)...)
 * Create a MessageProcessor.process() class and function for SNMP version 1
   and 2c
 * Security models will be created and separated off later
 * Should we maintain stats, or let agent implementations do that?

# Classes & Functions to Implement

 * RequestMessage
    * The constructor should either take a Buffer object or an Object, an
      Object will be created from the Buffer
 * ResponseMessage
    * The constructor should either take a Buffer object or an Object, an
      Object will be created from the Buffer
 * GetBulkRequestPdu
    * The constructor should either take a Buffer object or an Object, an
      Object will be created from the Buffer
 * GetNextRequestPdu
    * The constructor should either take a Buffer object or an Object, an
      Object will be created from the Buffer
 * GetResponsePdu
    * The constructor should either take a Buffer object or an Object, an
      Object will be created from the Buffer
 * GetRequestPdu
    * The constructor should either take a Buffer object or an Object, an
      Object will be created from the Buffer
 * InformRequestPdu
    * The constructor should either take a Buffer object or an Object, an
      Object will be created from the Buffer
 * SetRequestPdu
    * The constructor should either take a Buffer object or an Object, an
      Object will be created from the Buffer
 * TrapPdu
    * The constructor should either take a Buffer object or an Object, an
      Object will be created from the Buffer
 * TrapV2Pdu
    * The constructor should either take a Buffer object or an Object, an
      Object will be created from the Buffer

 * GenericMessageProcessor - version 1/2c message handling
 * V1MessageProcessor - based on GenericMessageProcessor
 * V2cMessageProcessor - based on GenericMessageProcessor

var dispatcher = new Dispatcher();

dispatcher.on("error", function(error) {

});

var transport = new TransportUdp();

transport.on("error", function(error) {

});

transport.on("close", function() {

});

dispatcher.validateCommunity(false);

transport.on("data", function(message) {
	dispatcher.dispatch(data, function(error, pdu) {
		if (error)
			dispatcher.emit("error", error);
		else
			dispatcher.emit("pdu", pdu);
	});
});

Dispatcher.dispatch = function (data, cb) {
	var reader = new ber.Reader(data);
	var version = this.getVersion(reader);
	var me = this;
	if (version == Version1 || version == Version2c)
		this.messageProcessors.genericMessageProcessor.process(data, function(error, pdu) {
			cb(error, pdu);
		});
	else
		cb(new UnsupportedVersionError("Unsupported version '" + version + "'"));
};

GenericMessageProcessor.process = function (data, cb) {
	try {
		var reader = ber.Reader();
		var version = this.readVersion(reader);
		var community = this.readCommunity(reader);
		var pdu = this.readPdu(reader);
		
		
	} catch (error) {
		cb(error);
	}
};
